"use strict";!function(){var e="new",t="uploading",a="completed",i="fail",n={components:{"vue-drag-uploader-item":{template:'\n<a class="vue-drag-uploader__item preview-img" :href="item.url || \'#\'" target="_blank">\n    <slot name="item" :item="item">\n        <div class="preview-img__body"\n            :style="{\'background-image\': \'url(\' + (item.url || item.thumbUrl) + \')\'}"></div>\n        <div class="preview-img__overlay">\n          <span class="preview-img__remove-icon fa fa-times"\n              @click.stop.prevent="deleteSelf()"></span>\n          <slot name="extra" :item="item"></slot>\n        </div>\n\n        <div class="preview-img__progress" v-if="state === \'uploading\'">\n            <div class="preview-img__progress-bar"\n                :style="{width: (progress * 100) + \'%\'}"\n            ></div>\n        </div>\n        <div class="preview-img__error-message error-message" v-if="state === \'fail\'" @click.stop.prevent="">\n            <span class="error-message__notice">上傳失敗</span>\n            <span class="error-message__message">{{ messages.error }}</span>\n        </div>\n    </slot>\n</a>\n    ',data:function(){return{state:a,progress:0,messages:{error:""}}},props:{item:Object,initState:String,uploadUrl:String},created:function(){this.state=this.initState,this.initState},mounted:function(){this.initState===e&&this.upload()},methods:{upload:function(){var e=this;this.state=t;var n=(new Date).valueOf(),s=new FormData;return s.append("file",this.item.file),this.$emit("upload-start",n),$.post({url:this.uploadUrl,data:s,contentType:!1,processData:!1,xhr:function(){var t=new XMLHttpRequest;return t.upload&&t.upload.addEventListener("progress",function(t){t.lengthComputable&&(e.progress=t.loaded/t.total,e.$emit("upload-progress",n,e.progress))},!1),t}}).done(function(t){e.state=a,e.item.url=t.data.url}).fail(function(t){console.warn(t.responseJSON.message,t),e.state=i,e.messages.error=t.responseJSON.message}).always(function(){e.item.file=null,e.$emit("upload-end",n)})},deleteSelf:function(){this.$emit("delete",this.item)}},watch:{}}},template:'\n<div class="vue-drag-uploader">\n    <div class="vue-drag-uploader__wrapper">\n        <slot name="items" \n            :items="items"\n            :url="url"\n            :max-files="maxFiles"\n            :files-limited="maxFiles"\n        >\n            <draggable v-model="items" class="vue-drag-uploader__draggable-wrapper" \n                :options="{draggable: \'.preview-img\'}">\n                <slot name="items" :item="items">\n                    <vue-drag-uploader-item\n                        v-for="(item, i) of items"\n                        :item="item"\n                        :init-state="item.uploadState"\n                        :key="item.key"\n                        :upload-url="url"\n                        @delete="deleteItem"\n                        @upload-start="uploadStart"\n                        @upload-end="uploadEnd"\n                        @upload-progress="uploadProgress"\n                        >\n                        <template slot="item">\n                            <slot name="item" \n                                :item="item" \n                                :i="i" \n                                :url="url"\n                                :max-files="maxFiles"\n                                :files-limited="maxFiles"></slot>\n                        </template>\n                        <template slot="extra">\n                            <slot name="extra" \n                                :item="item" \n                                :i="i" \n                                :url="url"\n                                :max-files="maxFiles"\n                                :files-limited="maxFiles"></slot>\n                        </template>\n                    </vue-drag-uploader-item>\n                </slot>\n                \n                <div v-if="canUpload" class="vue-drag-uploader__item add-button" :key="\'empty\'"\n                    @click="clickAdd()">\n                    <div class="add-button__body">\n                        <div class="add-button__icon">\n                            <span class="fa fa-upload fa-2x"></span>\n                        </div>\n                        <div class="add-button__text">\n                            拖拉圖片或按此上傳\n                        </div>\n                    </div>\n                </div>\n            </draggable>\n        </slot>\n    </div>\n</div>\n    ',data:function(){return{items:[],uploadQueue:{}}},props:{url:String,images:Array,maxFiles:[String,Number]},created:function(){var e=this;this.images.map(function(t){t.key=t.key||e.getKey(),t.uploadState=a}),this.items=this.images,null!=this.maxFiles&&this.maxFiles<this.items.length&&this.items.splice(this.maxFiles)},mounted:function(){var e=this;this.$el.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.currentTarget.classList.add("vue-drag-uploader--ondrag")}),this.$el.addEventListener("dragleave",function(e){e.stopPropagation(),e.preventDefault(),e.currentTarget.classList.remove("vue-drag-uploader--ondrag")}),this.$el.addEventListener("drop",function(t){t.stopPropagation(),t.preventDefault(),t.currentTarget.classList.remove("vue-drag-uploader--ondrag");var a=t.target.files||t.dataTransfer.files;e.uploadFiles(a)})},methods:{clickAdd:function(){var e=this,t=document.createElement("INPUT");t.setAttribute("type","file"),t.addEventListener("change",function(t){var a=t.target.files||t.dataTransfer.files;e.uploadFiles(a)}),t.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0}))},getKey:function(){var e=new Date;return e.getTime()+"."+e.getMilliseconds()+"."+Math.random()},uploadFiles:function(t){var a=this;Array.prototype.forEach.call(t,function(t){if(a.checkFile(t)&&a.canUpload){var i=new FileReader,n={id:"",key:a.getKey(),url:"",thumbUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",uploadState:e,file:t};a.items.push(n),i.onload=function(e){var t=e.target.result;n.thumbUrl=t},i.readAsDataURL(t)}})},checkFile:function(e){return-1!==["image/jpeg","image/png","image/gif"].indexOf(e.type)},deleteItem:function(e){this.$emit("delete-item",e),this.items=this.items.filter(function(t){return t.key!==e.key})},uploadStart:function(e){Vue.set(this.uploadQueue,e,0)},uploadEnd:function(e){Vue.delete(this.uploadQueue,e)},uploadProgress:function(e,t){this.uploadQueue[e]=t}},watch:{images:function(e){var t=this;e.map(function(e){e.key=e.key||t.getKey()}),this.items=e},items:{handler:function(e){this.$emit("change",e)},deep:!0},uploading:function(e){e?this.$emit("uploading"):this.$emit("uploaded")}},computed:{canUpload:function(){return null==this.maxFiles||this.items.length<this.maxFiles},uploading:function(){return Object.keys(this.uploadQueue),Object.keys(this.uploadQueue).length>0}}};Vue.component("vue-drag-uploader",n)}();