{"version":3,"sources":["cmf/contacts.js"],"names":["$","ContactPreview","fields","options","lang_prefix","handlers","init","modal","buttons","table","find","loading","editButton","bindEvents","hash","window","location","id","replace","showContact","self","on","event","preventDefault","data","Error","empty","hide","show","Phoenix","Ajax","get","Router","route","done","response","success","updateTable","item","console","log","message","then","fadeIn","fail","error","url","SimpleURI","setVar","attr","toString","each","key","undefined","addRow","details","Object","keys","length","text","Translator","translate","tr","append","k","e","value","cast","lang","html","callback","addFieldHandler","jQuery"],"mappings":"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","file":"contacts.js","sourcesContent":["/**\r\n * Part of earth project.\r\n *\r\n * @copyright  Copyright (C) 2017 ${ORGANIZATION}.\r\n * @license    __LICENSE__\r\n */\r\n\r\n(($) => {\r\n  const ContactPreview = {\r\n    fields: [\r\n      'id',\r\n      'subject',\r\n      'name',\r\n      'email',\r\n      'phone',\r\n      'url',\r\n      'created',\r\n      'content'\r\n    ],\r\n\r\n    options: {\r\n      lang_prefix: 'luna.'\r\n    },\r\n\r\n    handlers: {},\r\n\r\n    init() {\r\n      this.modal = $('#preview-modal');\r\n      this.buttons = $('[data-preview-button]');\r\n      this.table = this.modal.find('#preview-table');\r\n      this.loading = this.modal.find('#preview-loading');\r\n      this.editButton = this.modal.find('#preview-edit-button');\r\n\r\n      this.bindEvents();\r\n\r\n      const hash = window.location.hash;\r\n\r\n      if (hash) {\r\n        const id = hash.replace(/\\#contact-/, '');\r\n\r\n        this.showContact(id);\r\n      }\r\n    },\r\n\r\n    bindEvents() {\r\n      const self = this;\r\n      this.buttons.on('click', function(event) {\r\n        event.preventDefault();\r\n\r\n        const id = $(this).data('preview-id');\r\n\r\n        self.showContact(id);\r\n      });\r\n\r\n      this.modal.on('hide.bs.modal', function() {\r\n        window.location.hash = '';\r\n      });\r\n    },\r\n\r\n    showContact(id) {\r\n      const self = this;\r\n\r\n      if (!id) {\r\n        throw new Error('No preview ID.')\r\n      }\r\n\r\n      self.table.empty().hide();\r\n      self.loading.show();\r\n\r\n      window.location.hash = 'contact-' + id;\r\n\r\n      Phoenix.Ajax.get(Phoenix.Router.route('contact_preview'), {'id': id})\r\n        .done(function(response) {\r\n          if (response.success) {\r\n            self.updateTable(response.data.item);\r\n          } else {\r\n            console.log(response.message);\r\n          }\r\n        }).then(function() {\r\n        self.loading.hide();\r\n        self.table.fadeIn();\r\n      }).fail(function(error) {\r\n        console.log(error);\r\n      });\r\n\r\n      self.modal.modal('show');\r\n\r\n      // Replace edit button URL\r\n      const url = new SimpleURI(Phoenix.Router.route('contact_edit'));\r\n      url.setVar('id', id);\r\n      this.editButton.attr('href', url.toString());\r\n    },\r\n\r\n    updateTable(item) {\r\n      const self = this;\r\n\r\n      this.table.empty();\r\n\r\n      $.each(this.fields, function() {\r\n        const key = this.toString();\r\n\r\n        if (item[key] !== undefined) {\r\n          self.addRow(key, item[key]);\r\n        }\r\n      });\r\n\r\n      if (item.details && Object.keys(item.details).length) {\r\n        const text = Phoenix.Translator.translate(this.options.lang_prefix + 'contact.field.details');\r\n        const tr = $('<tr class=\"details-separator active\"><th style=\"text-align: center\" class=\"lead\" colspan=\"5\">' + text + '</th></tr>');\r\n        this.table.append(tr);\r\n      }\r\n\r\n      $.each(item.details, function(k, e) {\r\n        self.addRow(k, e ? e.toString() : '');\r\n      });\r\n    },\r\n\r\n    addRow(key, value) {\r\n      const tr = $('<tr class=\"row-' + key + '\"></tr>');\r\n\r\n      value = this.cast(key, value);\r\n\r\n      const lang = this.options.lang_prefix + 'contact.field.' + key;\r\n\r\n      tr.append($('<th width=\"150px\"></th>').text(Phoenix.Translator.translate(lang)));\r\n      tr.append($('<td></td>').html(value));\r\n\r\n      this.table.append(tr);\r\n    },\r\n\r\n    cast(key, value) {\r\n      if (value !== '') {\r\n        if (this.handlers[key] !== undefined) {\r\n          var callback = this.handlers[key];\r\n          return callback(key, value);\r\n        }\r\n\r\n        switch (key) {\r\n          case 'url':\r\n            value = '<a target=\"_blank\" href=\"' + value + '\">' + value + '</a>';\r\n            break;\r\n\r\n          case 'email':\r\n            value = '<a target=\"_blank\" href=\"mailto:' + value + '\">' + value + '</a>';\r\n            break;\r\n\r\n          case 'content':\r\n            value = value.replace(/\\n/g, '<br />');\r\n            break;\r\n        }\r\n      }\r\n\r\n      return value;\r\n    },\r\n\r\n    addFieldHandler(key, callback) {\r\n      this.handlers[key] = callback;\r\n\r\n      return this;\r\n    }\r\n  };\r\n\r\n  $(function() {\r\n    ContactPreview.init();\r\n  });\r\n\r\n  window.ContactPreview = ContactPreview;\r\n})(jQuery);\r\n"]}